name: Release workspace

on:
  workflow_dispatch:
    inputs:
      workspace:
        description: the name of the workspace / package to be released
        required: true
        type: string


jobs:
  release:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Enable Corepack (Yarn 4)
        run: |
          corepack enable
          corepack prepare yarn@4.4.1 --activate

      - name: Use Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: yarn

      - name: Install
        run: yarn install --immutable

      - name: Build
        run: yarn build --workspace "${{ inputs.workspace }}"

      - name: publish
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          # Configure npm with token for authentication
          echo "//registry.npmjs.org/:_authToken=\${NPM_TOKEN}" > ~/.npmrc
          
          # Publish only this workspace to npm
          yarn npm publish --workspace "${{ inputs.workspace }}"
          
          # Extract package name and version for git tag
          WORKSPACE_PATH="packages/${{ inputs.workspace }}"
          PACKAGE_NAME=$(jq -r '.name' "$WORKSPACE_PATH/package.json")
          PACKAGE_VERSION=$(jq -r '.version' "$WORKSPACE_PATH/package.json")
          TAG="${PACKAGE_NAME}@${PACKAGE_VERSION}"
          
          # Create and push git tag
          git tag "$TAG"
          git push origin "$TAG"
          
          echo "âœ“ Successfully published $TAG to npm"